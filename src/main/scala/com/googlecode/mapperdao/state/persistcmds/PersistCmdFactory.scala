package com.googlecode.mapperdao.state.persistcmds

import com.googlecode.mapperdao._
import java.util.IdentityHashMap

/**
 * entities are converted to PersistOps
 *
 * @author kostantinos.kougios
 *
 * 21 Nov 2012
 */
class PersistCmdFactory {

	private val alreadyProcessed = new IdentityHashMap[Any, PersistCmd[_, _]]

	def toInsertCmd[ID, T](
		entity: Entity[ID, _ <: DeclaredIds[ID], T],
		o: T) = insert(entity.asInstanceOf[Entity[ID, DeclaredIds[ID], T]], o)
	def toUpdateCmd[ID, T](
		entity: Entity[ID, _ <: DeclaredIds[ID], T],
		oldO: T with DeclaredIds[ID],
		newValuesMap: ValuesMap) = update(entity.asInstanceOf[Entity[ID, DeclaredIds[ID], T]], oldO, newValuesMap)

	private def insert[ID, T](
		entity: Entity[ID, DeclaredIds[ID], T],
		o: T) = {
		val op = alreadyProcessed.get(o)
		if (op == null) {
			val tpe = entity.tpe
			val table = tpe.table
			val columnAndValues = table.toListOfColumnAndValueTuples(table.simpleTypeNotAutoGeneratedColumns, o)
			val op = InsertCmd(entity, o, columnAndValues, Nil)
			alreadyProcessed.put(o, op)
			op
		} else
			AlreadyProcessedCmd(entity, o)
	}

	private def update[ID, T](
		entity: Entity[ID, DeclaredIds[ID], T],
		oldO: T with DeclaredIds[ID],
		newValuesMap: ValuesMap) = {
		val op = alreadyProcessed.get(oldO)
		if (op == null) {
			val tpe = entity.tpe
			val table = tpe.table
			val columnAndValues = newValuesMap.toListOfColumnAndValueTuple(table.simpleTypeNotAutoGeneratedColumns)
			val op = UpdateCmd(entity, oldO, newValuesMap, columnAndValues, Nil)
			alreadyProcessed.put(oldO, op)
			op
		} else
			AlreadyProcessedCmd(entity, oldO)
	}
}