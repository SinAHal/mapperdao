package com.googlecode.mapperdao.jdbc

import com.googlecode.mapperdao._
import com.googlecode.mapperdao.ops._
import com.googlecode.mapperdao.drivers.Driver
import org.springframework.jdbc.core.SqlParameterValue

/**
 * converts commands to database operations, executes
 * them and returns the resulting entity
 *
 * @author kostantinos.kougios
 *
 * 22 Nov 2012
 */
class CmdToDatabase(
		updateConfig: UpdateConfig,
		driver: Driver,
		typeManager: TypeManager) {

	private val jdbc = driver.jdbc

	private case class Node[ID, PC <: DeclaredIds[ID], T](
			sql: String,
			values: List[SqlParameterValue],
			entity: Entity[ID, PC, T],
			o: T,
			children: List[(ColumnInfoRelationshipBase[_, _, _, _, _], Node[_, _, _])],
			var keys: List[(SimpleColumn, Any)],
			var newO: Option[T with PC]) {

		def keysToMap = keys.map {
			case (c, v) => (c.name, v)
		}.toMap
	}

	def insert[ID, PC <: DeclaredIds[ID], T](
		cmds: List[PersistCmd[ID, PC, T]]): List[T with PC] = {
		// collect the sql and values
		val nodes = cmds.map { cmd =>
			val sql = toSql(cmd)
			Node(sql.sql, sql.values, cmd.entity, cmd.o, Nil, Nil, None)
		}

		// run the batch updates
		nodes.groupBy(_.sql).foreach {
			case (sql, nodes) =>
				val entity = nodes.head.entity
				val table = entity.tpe.table
				val autoGeneratedColumnNames = table.autoGeneratedColumnNamesArray
				val bo = BatchOptions(driver.batchStrategy, autoGeneratedColumnNames)
				val args = nodes.map {
					case Node(_, values, _, _, _, _, _) =>
						values.toArray
				}.toArray

				// do the batch update
				val br = jdbc.batchUpdate(bo, sql, args)

				// now extract the keys and set them into the nodes
				val keys = br.keys map { m =>
					table.autoGeneratedColumns.map { column =>
						(column, driver.getAutoGenerated(m, column))
					}
				}
				(nodes zip keys) foreach {
					case (node, key) => node.keys = key
				}
				nodes
		}

		// reconstruct the persisted entities
		val entities = nodes.map { node =>
			val entity = node.entity
			val newM = ValuesMap.entityToMap(typeManager, entity.tpe, node.o, false) ++ node.keysToMap
			val newVM = ValuesMap.fromMap(newM)
			entity.constructor(updateConfig.data, newVM)
		}
		entities
	}

	private def toSql(cmd: PersistCmd[_, _, _]) = cmd match {
		case InsertCmd(entity, o, columns) =>
			driver.insertSql(entity.tpe, columns).result
	}
}