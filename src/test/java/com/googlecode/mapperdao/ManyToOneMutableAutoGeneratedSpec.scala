package com.googlecode.mapperdao

import org.specs2.mutable.SpecificationWithJUnit
import com.googlecode.mapperdao.jdbc.Setup

/**
 * @author kostantinos.kougios
 *
 * 6 Sep 2011
 */
class ManyToOneMutableAutoGeneratedSpec extends SpecificationWithJUnit {
	import ManyToOneMutableAutoGeneratedSpec._
	val (jdbc, mapperDao) = Setup.setupMapperDao(TypeRegistry(PersonEntity, CompanyEntity, HouseEntity))

	import mapperDao._

	"update to null both FK" in {
		createTables

		val company1 = insert(CompanyEntity, Company("Coders limited"))
		val house = House("Rhodes,Greece")
		val person = Person("Kostas", company1, house)

		val inserted = insert(PersonEntity, person)
		inserted must_== person

		inserted.name = "changed"
		inserted.company = null
		inserted.lives = null
		val updated = update(PersonEntity, inserted)
		updated must_== inserted

		val selected = select(PersonEntity, inserted.id).get
		selected must_== updated

		mapperDao.delete(PersonEntity, selected)
		mapperDao.select(PersonEntity, selected.id) must beNone
	}

	"update to null" in {
		createTables

		val company1 = insert(CompanyEntity, Company("Coders limited"))
		val house = House("Rhodes,Greece")
		val person = Person("Kostas", company1, house)

		val inserted = insert(PersonEntity, person)
		inserted must_== person

		inserted.name = "changed"
		inserted.company = null

		val updated = update(PersonEntity, inserted)
		updated must_== inserted

		val selected = select(PersonEntity, updated.id).get
		selected must_== updated

		mapperDao.delete(PersonEntity, selected)
		mapperDao.select(PersonEntity, selected.id) must beNone
	}

	"update" in {
		createTables

		import mapperDao._
		val company1 = insert(CompanyEntity, Company("Coders limited"))
		val company2 = insert(CompanyEntity, Company("Scala Inc"))
		val house = House("Rhodes,Greece")
		val person = Person("Kostas", company1, house)

		val inserted = insert(PersonEntity, person)
		inserted must_== person
		inserted.company = company2
		val updated = update(PersonEntity, inserted)
		updated must_== inserted

		val selected = select(PersonEntity, updated.id).get
		selected must_== updated

		mapperDao.delete(PersonEntity, selected)
		mapperDao.select(PersonEntity, selected.id) must beNone
	}

	def createTables =
		{
			jdbc.update("drop table if exists Person cascade")
			jdbc.update("drop table if exists Company cascade")
			jdbc.update("drop table if exists House cascade")

			jdbc.update("""
					create table Company (
						id serial not null,
						name varchar(100) not null,
						primary key(id)
					)
			""")
			jdbc.update("""
					create table House (
						id serial not null,
						address varchar(100) not null,
						primary key(id)
					)
			""")
			jdbc.update("""
					create table Person (
						id serial not null,
						name varchar(100) not null,
						company_id int,
						house_id int,
						primary key(id),
						foreign key (company_id) references Company(id) on delete cascade,
						foreign key (house_id) references House(id) on delete cascade
					)
			""")
		}
}

object ManyToOneMutableAutoGeneratedSpec {
	case class Person(var name: String, var company: Company, var lives: House)
	case class Company(var name: String)
	case class House(var address: String)

	object PersonEntity extends Entity[IntId, Person](classOf[Person]) {
		val id = autoGeneratedPK("id", _.id)
		val name = string("name", _.name)
		val company = manyToOne(classOf[Company], _.company)
		val lives = manyToOne(classOf[House], _.lives)

		val constructor = (m: ValuesMap) => new Person(m(name), m(company), m(lives)) with IntId with Persisted {
			val valuesMap = m
			val id = m.int(PersonEntity.id) // we call m.int cause mysql returns BigInteger for autogenerated serial columns
		}
	}

	object CompanyEntity extends Entity[IntId, Company](classOf[Company]) {
		val id = autoGeneratedPK("id", _.id)
		val name = string("name", _.name)

		val constructor = (m: ValuesMap) => new Company(m(name)) with IntId with Persisted {
			val valuesMap = m
			val id = m.int(CompanyEntity.id) // we call m.int cause mysql returns BigInteger for autogenerated serial columns
		}
	}

	object HouseEntity extends Entity[IntId, House](classOf[House]) {
		val id = autoGeneratedPK("id", _.id)
		val address = string("address", _.address)
		val constructor = (m: ValuesMap) => new House(m(address)) with IntId with Persisted {
			val valuesMap = m
			val id = m.int(HouseEntity.id) // we call m.int cause mysql returns BigInteger for autogenerated serial columns
		}
	}
}